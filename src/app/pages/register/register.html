<div class="register-page" [class.step2]="currentStep === 2">

  <!-- Sfondo animato -->
  <div class="bg-shapes">
    <div class="shape shape-1"></div>
    <div class="shape shape-2"></div>
    <div class="shape shape-3"></div>
  </div>

  <div class="register-wrapper" [class.wide]="currentStep === 2">

    <!-- Brand -->
    <div class="brand">
      <div class="brand-icon">‚ú¶</div>
      <h1 class="brand-name">Gestionale Tesi</h1>
    </div>

    <form [formGroup]="registerForm" class="glass-card" [class.wide]="currentStep === 2">

      <!-- Header step -->
      <ng-container *ngIf="currentStep !== 3">
        <div class="card-header">
          <h2 class="card-title">Crea il tuo Account</h2>
          <div class="step-track">
            <div class="step-pill" [class.active]="currentStep === 1" [class.done]="currentStep > 1">
              <span class="step-num">1</span>
              <span class="step-label">Dati Personali</span>
            </div>
            <div class="step-line" [class.done]="currentStep > 1"></div>
            <div class="step-pill" [class.active]="currentStep === 2">
              <span class="step-num">2</span>
              <span class="step-label">Piano</span>
            </div>
          </div>
        </div>
      </ng-container>

      <!-- STEP 1 -->
      <div *ngIf="currentStep === 1" class="step-body">

        <!-- Avatar upload -->
        <div class="avatar-upload">
          <input type="file" id="actual-btn" (change)="onFileSelected($event)" accept="image/*" hidden />
          <label for="actual-btn" class="avatar-label">
            <ng-container *ngIf="profilePictureBase64">
              <img [src]="profilePictureBase64" alt="Anteprima" class="avatar-preview">
              <div class="avatar-overlay">üì∑</div>
            </ng-container>
            <ng-container *ngIf="!profilePictureBase64">
              <div class="avatar-placeholder">
                <span class="avatar-plus">+</span>
                <span class="avatar-text">Foto</span>
              </div>
            </ng-container>
          </label>
          <p class="avatar-hint">Opzionale</p>
        </div>

        <!-- Campi in griglia -->
        <div class="fields-grid">
          <div class="field-group">
            <label class="field-label">Nome</label>
            <input type="text" formControlName="firstName" placeholder="Mario" class="field-input">
          </div>
          <div class="field-group">
            <label class="field-label">Cognome</label>
            <input type="text" formControlName="lastName" placeholder="Rossi" class="field-input">
          </div>
        </div>

        <div class="field-group">
          <label class="field-label">Email</label>
          <div class="input-wrapper">
            <span class="input-icon">@</span>
            <input type="email" formControlName="email" placeholder="mario@example.com" class="field-input with-icon">
          </div>
        </div>

        <div class="field-group">
          <label class="field-label">Password</label>
          <div class="input-wrapper">
            <span class="input-icon">‚óâ</span>
            <input type="password" formControlName="password" placeholder="Minimo 6 caratteri"
              class="field-input with-icon">
          </div>
        </div>

        <button type="button" class="btn-primary" (click)="goToStep2()">
          <span>Avanti</span><span class="btn-arrow">‚Üí</span>
        </button>

        <div class="card-footer">
          Hai gi√† un account? <a routerLink="/login" class="link">Accedi</a>
        </div>
      </div>

      <!-- STEP 2 -->
      <div *ngIf="currentStep === 2" class="step-body">

        <div class="field-group plans-section">
          <label class="field-label text-center">Scegli il tuo Piano</label>

          <div class="pricing-carousel">
            <div class="pricing-card" *ngFor="let plan of plans; let i = index"
              [class.selected]="registerForm.value.selectedPlanId === plan.id" (click)="selectPlan(plan.id)">

              <!-- Badge "Popular", "Best", "New" in base all'indice -->
              <div class="pc-badge" *ngIf="i === 1">Vantaggioso</div>
              <div class="pc-badge" *ngIf="i === 2">Premium</div>

              <div class="pc-header">
                <h3 class="pc-name">{{ plan.name }}</h3>
              </div>

              <div class="pc-price-block">
                <div class="pc-price">
                  <span class="currency">‚Ç¨</span>
                  <span class="amount">{{ plan.fullPrice }}</span>
                </div>
                <span class="pc-period">Contratto {{ plan.name }}</span>
              </div>

              <div class="pc-features">
                <div class="feature-item">
                  <span class="feature-dot"></span> Schede PT personalizzate
                </div>
                <div class="feature-item">
                  <span class="feature-dot"></span> Piano alimentare mensile
                </div>
                <div class="feature-item">
                  <span class="feature-dot"></span> Appuntamenti inclusi
                </div>
              </div>

              <button type="button" class="btn-select-plan">
                {{ registerForm.value.selectedPlanId === plan.id ? 'Selezionato' : 'Scegli' }}
              </button>
            </div>
          </div>

          <!-- L'input reale rimane nascosto -->
          <input type="hidden" formControlName="selectedPlanId">
        </div>

        <div class="field-group">
          <label class="field-label text-center">Metodo di pagamento</label>
          <select formControlName="paymentFrequency" class="field-select">
            <option value="UNICA_SOLUZIONE">Pagamento Unico (Risparmia)</option>
            <option value="RATE_MENSILI">Rate Mensili</option>
          </select>
        </div>

        <div class="section-divider"></div>
        <h3 class="section-heading">Scegli i tuoi Professionisti</h3>

        <!-- PT Picker -->
        <div class="field-group">
          <label class="field-label">üí™ Personal Trainer</label>
          <div class="prof-search-wrap">
            <span class="prof-search-icon">üîç</span>
            <input type="text" class="prof-search-input" placeholder="Cerca per nome..." [(ngModel)]="ptSearch"
              [ngModelOptions]="{standalone: true}">
          </div>
          <div class="prof-grid">
            <div class="prof-card" *ngFor="let pt of filteredPts"
              [class.selected]="registerForm.value.selectedPtId === pt.id" [class.sold-out]="pt.isSoldOut"
              (click)="!pt.isSoldOut && selectPt(pt.id)">
              <div class="prof-avatar">
                <img *ngIf="pt.profilePicture" [src]="pt.profilePicture" [alt]="pt.fullName">
                <span *ngIf="!pt.profilePicture" class="prof-initials">{{ getInitials(pt.fullName) }}</span>
              </div>
              <div class="prof-info">
                <span class="prof-name">{{ pt.fullName }}</span>
                <span class="prof-rating">
                  ‚≠ê {{ (pt.averageRating | number:'1.1-1') }}<span class="prof-rating-max">/5</span>
                </span>
              </div>
              <span *ngIf="pt.isSoldOut" class="prof-sold-out-badge">Completo</span>
              <span *ngIf="registerForm.value.selectedPtId === pt.id" class="prof-check">‚úì</span>
            </div>
            <div *ngIf="filteredPts.length === 0" class="prof-empty">Nessun risultato</div>
          </div>
          <input type="hidden" formControlName="selectedPtId">
        </div>

        <!-- Nutrizionista Picker -->
        <div class="field-group">
          <label class="field-label">ü•ó Nutrizionista</label>
          <div class="prof-search-wrap">
            <span class="prof-search-icon">üîç</span>
            <input type="text" class="prof-search-input" placeholder="Cerca per nome..." [(ngModel)]="nutSearch"
              [ngModelOptions]="{standalone: true}">
          </div>
          <div class="prof-grid">
            <div class="prof-card" *ngFor="let nut of filteredNuts"
              [class.selected]="registerForm.value.selectedNutritionistId === nut.id" [class.sold-out]="nut.isSoldOut"
              (click)="!nut.isSoldOut && selectNut(nut.id)">
              <div class="prof-avatar">
                <img *ngIf="nut.profilePicture" [src]="nut.profilePicture" [alt]="nut.fullName">
                <span *ngIf="!nut.profilePicture" class="prof-initials">{{ getInitials(nut.fullName) }}</span>
              </div>
              <div class="prof-info">
                <span class="prof-name">{{ nut.fullName }}</span>
                <span class="prof-rating">
                  ‚≠ê {{ (nut.averageRating | number:'1.1-1') }}<span class="prof-rating-max">/5</span>
                </span>
              </div>
              <span *ngIf="nut.isSoldOut" class="prof-sold-out-badge">Completo</span>
              <span *ngIf="registerForm.value.selectedNutritionistId === nut.id" class="prof-check">‚úì</span>
            </div>
            <div *ngIf="filteredNuts.length === 0" class="prof-empty">Nessun risultato</div>
          </div>
          <input type="hidden" formControlName="selectedNutritionistId">
        </div>


        <div class="btn-row">
          <button type="button" class="btn-secondary" (click)="goToStep1()" [disabled]="isLoading">
            ‚Üê Indietro
          </button>
          <button type="button" class="btn-primary btn-submit" (click)="onSubmit()" [disabled]="isLoading">
            <span *ngIf="!isLoading">Completa ‚Üí</span>
            <span *ngIf="isLoading" class="loading-dots">Invio<span>.</span><span>.</span><span>.</span></span>
          </button>
        </div>

      </div>

      <!-- STEP 3: Successo -->
      <div *ngIf="currentStep === 3" class="success-body">
        <div class="success-ring">
          <div class="success-check">‚úì</div>
        </div>
        <h3 class="success-title">Benvenuto/a!</h3>
        <p class="success-text">Il tuo account √® stato creato con successo.</p>
        <p class="success-redirect">Reindirizzamento al login in corso...</p>
        <button type="button" class="btn-primary" routerLink="/login">Vai al Login ‚Üí</button>
      </div>

    </form>
  </div>

</div>

<!-- TOAST -->
<div class="toast-wrapper" *ngIf="toast" [class.toast-success]="toast.type === 'success'"
  [class.toast-error]="toast.type === 'error'">
  <div class="toast-icon-wrap">{{ toast.type === 'success' ? '‚úì' : '!' }}</div>
  <span class="toast-message">{{ toast.message }}</span>
  <button class="toast-close" (click)="dismissToast()">‚úï</button>
</div>