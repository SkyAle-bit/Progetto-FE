<div class="register-page">

  <!-- Sfondo animato -->
  <div class="bg-shapes">
    <div class="shape shape-1"></div>
    <div class="shape shape-2"></div>
    <div class="shape shape-3"></div>
  </div>

  <div class="register-wrapper">

    <!-- Brand -->
    <div class="brand">
      <div class="brand-icon">‚ú¶</div>
      <h1 class="brand-name">Gestionale Tesi</h1>
    </div>

    <form [formGroup]="registerForm" class="glass-card">

      <!-- Header step -->
      <ng-container *ngIf="currentStep !== 3">
        <div class="card-header">
          <h2 class="card-title">Crea il tuo Account</h2>
          <div class="step-track">
            <div class="step-pill" [class.active]="currentStep === 1" [class.done]="currentStep > 1">
              <span class="step-num">1</span>
              <span class="step-label">Dati Personali</span>
            </div>
            <div class="step-line" [class.done]="currentStep > 1"></div>
            <div class="step-pill" [class.active]="currentStep === 2">
              <span class="step-num">2</span>
              <span class="step-label">Piano</span>
            </div>
          </div>
        </div>
      </ng-container>

      <!-- STEP 1 -->
      <div *ngIf="currentStep === 1" class="step-body">

        <!-- Avatar upload -->
        <div class="avatar-upload">
          <input type="file" id="actual-btn" (change)="onFileSelected($event)" accept="image/*" hidden/>
          <label for="actual-btn" class="avatar-label">
            <ng-container *ngIf="profilePictureBase64">
              <img [src]="profilePictureBase64" alt="Anteprima" class="avatar-preview">
              <div class="avatar-overlay">üì∑</div>
            </ng-container>
            <ng-container *ngIf="!profilePictureBase64">
              <div class="avatar-placeholder">
                <span class="avatar-plus">+</span>
                <span class="avatar-text">Foto</span>
              </div>
            </ng-container>
          </label>
          <p class="avatar-hint">Opzionale</p>
        </div>

        <!-- Campi in griglia -->
        <div class="fields-grid">
          <div class="field-group">
            <label class="field-label">Nome</label>
            <input type="text" formControlName="firstName" placeholder="Mario" class="field-input">
          </div>
          <div class="field-group">
            <label class="field-label">Cognome</label>
            <input type="text" formControlName="lastName" placeholder="Rossi" class="field-input">
          </div>
        </div>

        <div class="field-group">
          <label class="field-label">Email</label>
          <div class="input-wrapper">
            <span class="input-icon">@</span>
            <input type="email" formControlName="email" placeholder="mario@example.com" class="field-input with-icon">
          </div>
        </div>

        <div class="field-group">
          <label class="field-label">Password</label>
          <div class="input-wrapper">
            <span class="input-icon">‚óâ</span>
            <input type="password" formControlName="password" placeholder="Minimo 6 caratteri" class="field-input with-icon">
          </div>
        </div>

        <button type="button" class="btn-primary" (click)="goToStep2()">
          <span>Avanti</span><span class="btn-arrow">‚Üí</span>
        </button>

        <div class="card-footer">
          Hai gi√† un account? <a routerLink="/login" class="link">Accedi</a>
        </div>
      </div>

      <!-- STEP 2 -->
      <div *ngIf="currentStep === 2" class="step-body">

        <div class="field-group">
          <label class="field-label">Piano</label>
          <select formControlName="selectedPlanId" class="field-select">
            <option value="" disabled selected>Seleziona un piano...</option>
            <option *ngFor="let plan of plans" [value]="plan.id">
              {{ plan.name }} ‚Äî {{ plan.duration }} mesi ‚Äî {{ plan.fullPrice }}‚Ç¨
            </option>
          </select>
        </div>

        <div class="field-group">
          <label class="field-label">Metodo di pagamento</label>
          <select formControlName="paymentFrequency" class="field-select">
            <option value="UNICA_SOLUZIONE">Pagamento Unico (Risparmia)</option>
            <option value="RATE_MENSILI">Rate Mensili</option>
          </select>
        </div>

        <div class="field-group">
          <label class="field-label">Personal Trainer</label>
          <select formControlName="selectedPtId" class="field-select">
            <option value="" disabled selected>Seleziona il PT...</option>
            <option *ngFor="let pt of personalTrainers" [value]="pt.id" [disabled]="pt.isSoldOut">
              {{ pt.fullName }} ‚≠ê {{ pt.averageRating }}<span *ngIf="pt.isSoldOut"> ‚Äî AL COMPLETO</span>
            </option>
          </select>
        </div>

        <div class="field-group">
          <label class="field-label">Nutrizionista</label>
          <select formControlName="selectedNutritionistId" class="field-select">
            <option value="" disabled selected>Seleziona il Nutrizionista...</option>
            <option *ngFor="let nut of nutritionists" [value]="nut.id" [disabled]="nut.isSoldOut">
              {{ nut.fullName }} ‚≠ê {{ nut.averageRating }}<span *ngIf="nut.isSoldOut"> ‚Äî AL COMPLETO</span>
            </option>
          </select>
        </div>

        <div class="btn-row">
          <button type="button" class="btn-secondary" (click)="goToStep1()" [disabled]="isLoading">
            ‚Üê Indietro
          </button>
          <button type="button" class="btn-primary btn-submit" (click)="onSubmit()" [disabled]="isLoading">
            <span *ngIf="!isLoading">Completa ‚Üí</span>
            <span *ngIf="isLoading" class="loading-dots">Invio<span>.</span><span>.</span><span>.</span></span>
          </button>
        </div>

      </div>

      <!-- STEP 3: Successo -->
      <div *ngIf="currentStep === 3" class="success-body">
        <div class="success-ring">
          <div class="success-check">‚úì</div>
        </div>
        <h3 class="success-title">Benvenuto/a!</h3>
        <p class="success-text">Il tuo account √® stato creato con successo.</p>
        <p class="success-redirect">Reindirizzamento al login in corso...</p>
        <button type="button" class="btn-primary" routerLink="/login">Vai al Login ‚Üí</button>
      </div>

    </form>
  </div>

</div>

<!-- TOAST -->
<div class="toast-wrapper" *ngIf="toast" [class.toast-success]="toast.type === 'success'" [class.toast-error]="toast.type === 'error'">
  <div class="toast-icon-wrap">{{ toast.type === 'success' ? '‚úì' : '!' }}</div>
  <span class="toast-message">{{ toast.message }}</span>
  <button class="toast-close" (click)="dismissToast()">‚úï</button>
</div>
