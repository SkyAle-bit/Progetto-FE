<div class="dashboard-page">

  <!-- ‚îÄ‚îÄ TOPBAR ‚îÄ‚îÄ -->
  <header class="topbar">
    <div class="topbar-brand">
      <span class="brand-star">‚ú¶</span>
      <span class="brand-name">Gestionale Tesi</span>
    </div>

    <div class="topbar-center">
      <button class="nav-btn" (click)="prevWeek()">‚Äπ</button>
      <span class="week-label">{{ getWeekLabel() }}</span>
      <button class="nav-btn" (click)="nextWeek()">‚Ä∫</button>
      <button class="today-btn" (click)="goToToday()">Oggi</button>
    </div>

    <div class="topbar-right">
      <!-- Statistiche (Professionisti) -->
      <div class="week-stat" *ngIf="!isLoading && isProfessional()">
        <span class="week-stat-num">{{ countWeekBookings() }}</span>
        <span class="week-stat-label">questa settimana</span>
      </div>

      <!-- Crediti e Prenotazione (Clienti) -->
      <div class="topbar-credits" *ngIf="!isLoading && isClient() && subscription?.active">
        <div class="topbar-credit-badges">
          <div class="topbar-credit-badge">
            <span class="tc-icon">üí™</span>
            <span class="tc-num">{{ subscription.remainingPtCredits }}</span>
          </div>
          <div class="topbar-credit-badge nutritionist">
            <span class="tc-icon">ü•ó</span>
            <span class="tc-num">{{ subscription.remainingNutritionistCredits }}</span>
          </div>
        </div>
        <button class="btn-book-topbar" (click)="toggleProfile()">
          Prenota
        </button>
      </div>
      <!-- Bottone disponibilit√† in topbar ‚Äî solo professionisti -->
      <button *ngIf="isProfessional()" class="btn-avail-topbar" (click)="openAvailability()"
        title="Gestisci disponibilit√† settimana prossima">
        <span>üìÖ</span> Disponibilit√†
      </button>
      <button class="profile-btn" (click)="toggleProfile()" [class.active]="isProfileOpen">
        <img *ngIf="currentUser?.profilePicture" [src]="currentUser.profilePicture" alt="Avatar"
          class="profile-btn-img">
        <span *ngIf="!currentUser?.profilePicture" class="profile-btn-initials">{{ getInitials() }}</span>
      </button>
    </div>
  </header>

  <!-- ‚îÄ‚îÄ CALENDARIO ‚îÄ‚îÄ -->
  <div class="calendar-wrapper">

    <div class="loading-overlay" *ngIf="isLoading">
      <div class="loading-spinner"></div>
      <span class="loading-text">Caricamento in corso...</span>
    </div>

    <!-- Intestazione giorni -->
    <div class="calendar-header">
      <div class="time-gutter"></div>
      <div class="day-header" *ngFor="let day of weekDays" [class.today]="isToday(day)">
        <span class="day-name">{{ getDayName(day) }}</span>
        <span class="day-number" [class.today-circle]="isToday(day)">{{ getDayNumber(day) }}</span>
      </div>
    </div>

    <!-- Griglia -->
    <div class="calendar-grid-scroll">
      <div class="calendar-grid">

        <!-- Colonna ore -->
        <div class="time-col">
          <div class="time-slot-label" *ngFor="let slot of timeSlots" [class.full-hour]="isFullHour(slot)"
            [class.half-hour]="!isFullHour(slot)">
            {{ slot }}
          </div>
        </div>

        <!-- Colonne giorni -->
        <div class="day-col" *ngFor="let day of weekDays" [class.today-col]="isToday(day)">
          <div class="hour-cell" *ngFor="let slot of timeSlots" [class.full-hour]="isFullHour(slot)"
            [class.half-hour]="!isFullHour(slot)">
            <div class="booking-card" *ngFor="let b of getBookingsForSlot(day, slot)"
              [class]="'booking-card ' + getBookingClass(b)">
              <div class="booking-time">{{ b.startTime }} ‚Äì {{ b.endTime }}</div>
              <div class="booking-name">{{ getBookingLabel(b) }}</div>
              <div class="booking-status" [class]="'status-' + b.status?.toLowerCase()">
                {{ b.status === 'CONFIRMED' ? '‚óè Confermata' : b.status === 'PENDING' ? '‚óã In attesa' : '‚úï Annullata' }}
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- Stato vuoto -->
    <div class="empty-state" *ngIf="!isLoading && bookings.length === 0">
      <div class="empty-icon">üìÖ</div>
      <p class="empty-title">Nessuna prenotazione</p>
      <p class="empty-sub" *ngIf="isClient()">Non hai ancora prenotazioni con i tuoi professionisti.</p>
      <p class="empty-sub" *ngIf="isProfessional()">Nessun cliente ha ancora prenotato con te.</p>
    </div>

  </div>

  <!-- ‚îÄ‚îÄ OVERLAY PROFILO ‚îÄ‚îÄ -->
  <div class="panel-overlay" *ngIf="isProfileOpen" (click)="closeProfile()"></div>

  <!-- ‚îÄ‚îÄ PANNELLO PROFILO ‚îÄ‚îÄ -->
  <aside class="profile-panel" [class.open]="isProfileOpen">

    <div class="panel-header">
      <span class="panel-title">Il tuo Profilo</span>
      <button class="panel-close" (click)="closeProfile()">‚úï</button>
    </div>

    <div class="panel-body">

      <ng-container *ngIf="isLoading">
        <div class="skeleton-avatar"></div>
        <div class="skeleton-line wide"></div>
        <div class="skeleton-line narrow"></div>
      </ng-container>

      <ng-container *ngIf="!isLoading && dashboardData">

        <div class="panel-avatar-wrap">
          <img *ngIf="currentUser?.profilePicture" [src]="currentUser.profilePicture" alt="Avatar" class="panel-avatar">
          <div *ngIf="!currentUser?.profilePicture" class="panel-avatar-fallback">{{ getInitials() }}</div>
          <div class="panel-avatar-ring"></div>
        </div>

        <div class="panel-name">{{ profile?.firstName }} {{ profile?.lastName }}</div>
        <div class="panel-role-badge">{{ profile?.role }}</div>

        <!-- Bottone disponibilit√† ‚Äî solo professionisti -->
        <button *ngIf="isProfessional()" class="btn-availability" (click)="openAvailability()">
          <span class="btn-availability-icon">üìÖ</span>
          Gestisci Disponibilit√†
          <span class="btn-availability-arrow">‚Üí</span>
        </button>

        <div class="panel-section-title">Dati Personali</div>
        <div class="panel-details">
          <div class="detail-row">
            <span class="detail-icon">‚úâ</span>
            <div class="detail-content">
              <span class="detail-label">Email</span>
              <span class="detail-value">{{ profile?.email }}</span>
            </div>
          </div>
        </div>

        <ng-container *ngIf="isClient() && subscription">
          <div class="panel-section-title">Abbonamento</div>
          <div class="subscription-card" [class.inactive]="!subscription.isActive">
            <div class="sub-plan-name">{{ subscription.planName }}</div>
            <div class="sub-status">
              <span class="sub-dot" [class.active]="subscription.isActive"></span>
              {{ subscription.isActive ? 'Attivo' : 'Scaduto' }}
            </div>
            <div class="sub-dates">Scade il {{ subscription.endDate | date:'d MMMM yyyy':'':'it' }}</div>
            <div class="sub-days-left" *ngIf="subscription.isActive">{{ getSubscriptionDaysLeft() }} giorni rimanenti
            </div>
            <div class="sub-credits">
              <div class="credit-item">
                <span class="credit-icon">üí™</span>
                <span class="credit-label">PT</span>
                <span class="credit-num">{{ subscription.remainingPtCredits }}</span>
              </div>
              <div class="credit-item">
                <span class="credit-icon">ü•ó</span>
                <span class="credit-label">Nutrizione</span>
                <span class="credit-num">{{ subscription.remainingNutritionistCredits }}</span>
              </div>
            </div>
          </div>
        </ng-container>

        <ng-container *ngIf="isClient() && professionals.length > 0">
          <div class="panel-section-title">I tuoi Professionisti</div>
          <div class="panel-details">
            <div class="detail-row" *ngFor="let p of professionals">
              <span class="detail-icon">{{ p.role === 'PERSONAL_TRAINER' ? 'üí™' : 'ü•ó' }}</span>
              <div class="detail-content" style="flex: 1;">
                <span class="detail-label">{{ p.role === 'PERSONAL_TRAINER' ? 'Personal Trainer' : 'Nutrizionista'
                  }}</span>
                <span class="detail-value">{{ p.fullName }}</span>
              </div>
              <button class="btn-book-sm" (click)="openBooking(p)">Prenota</button>
            </div>
          </div>
        </ng-container>

      </ng-container>

      <button class="btn-logout" (click)="logout()">Esci dall'account ‚Üí</button>

    </div>
  </aside>

  <!-- ‚îÄ‚îÄ MODALE DISPONIBILIT√Ä ‚îÄ‚îÄ -->
  <div class="avail-overlay" *ngIf="isAvailabilityOpen" (click)="closeAvailability()"></div>

  <div class="avail-modal" *ngIf="isAvailabilityOpen">

    <!-- Header modale -->
    <div class="avail-header">
      <div class="avail-header-text">
        <span class="avail-title">Disponibilit√† Settimana Prossima</span>
        <span class="avail-subtitle">{{ getNextWeekLabel() }}</span>
      </div>
      <button class="avail-close" (click)="closeAvailability()">‚úï</button>
    </div>

    <!-- Intestazione giorni -->
    <div class="avail-days-header">
      <div class="avail-time-gutter">
        <button *ngIf="isCopyMode" class="btn-cancel-copy" (click)="clearCopy()" title="Annulla copia">‚úï</button>
      </div>
      <div class="avail-day-header" *ngFor="let day of nextWeekDays" [class.is-copy-source]="isCopiedDay(day)">
        <span class="avail-day-name">{{ getDayName(day) }}</span>
        <span class="avail-day-number">{{ getDayNumber(day) }}</span>
        <!-- Giorno sorgente copiato -->
        <span *ngIf="isCopiedDay(day)" class="badge-copied">‚úì Copiato</span>
        <!-- In copy mode: mostra Incolla sugli altri giorni -->
        <button *ngIf="isCopyMode && !isCopiedDay(day)" class="btn-paste-day" (click)="pasteDay(day)">‚¨á Incolla</button>
        <!-- Normale: mostra Copia se ha slot -->
        <button *ngIf="!isCopyMode" class="btn-copy-day" (click)="copyDay(day)" [disabled]="!hasDaySlots(day)"
          title="Copia disponibilit√†">‚ßâ Copia</button>
      </div>
    </div>


    <!-- Griglia slot -->
    <div class="avail-body">
      <div class="avail-grid">

        <!-- Colonna ore -->
        <div class="avail-time-col">
          <div class="avail-time-label" *ngFor="let slot of timeSlots" [class.full-hour]="isFullHour(slot)"
            [class.half-hour]="!isFullHour(slot)">
            {{ isFullHour(slot) ? slot : '' }}
          </div>
        </div>

        <!-- Colonne giorni -->
        <div class="avail-day-col" *ngFor="let day of nextWeekDays"
          [class.is-paste-target]="isCopyMode && !isCopiedDay(day)" [class.is-copy-source]="isCopiedDay(day)">
          <div class="avail-slot" *ngFor="let slot of timeSlots" [class.full-hour]="isFullHour(slot)"
            [class.half-hour]="!isFullHour(slot)" [class.selected]="isSlotSelected(day, slot)"
            [class.existing]="isSlotExisting(day, slot)" [class.locked]="isSlotLocked(day, slot)"
            (click)="toggleSlot(day, slot)"
            [title]="getDayName(day) + ' ' + getDayNumber(day) + ' ‚Äî ' + slot + (isSlotLocked(day, slot) ? ' (Prenotato)' : '')">
            <span *ngIf="isSlotLocked(day, slot)" class="slot-lock-icon">üîí</span>
          </div>
        </div>

      </div>
    </div>

    <!-- Footer -->
    <div class="avail-footer">
      <span class="avail-counter">
        <span class="avail-counter-num">{{ getSelectedCount() }}</span>
        slot selezionati
        <span class="avail-counter-hours">({{ (getSelectedCount() * 0.5).toFixed(1) }}h totali)</span>
      </span>
      <div class="avail-footer-actions">
        <button class="btn-avail-cancel" (click)="closeAvailability()">Annulla</button>
        <button class="btn-avail-confirm" (click)="confirmAvailability()" [disabled]="getSelectedCount() === 0">
          Conferma Disponibilit√†
        </button>
      </div>
    </div>

  </div>

  <!-- ‚îÄ‚îÄ MODALE PRENOTAZIONE CLIENTE ‚îÄ‚îÄ -->
  <div class="booking-overlay" *ngIf="isBookingOpen" (click)="closeBooking()"></div>

  <div class="booking-modal" *ngIf="isBookingOpen">
    <!-- Header modale -->
    <div class="booking-header">
      <div class="booking-header-text">
        <span class="booking-title">Prenota con {{ selectedProfessional?.fullName }}</span>
        <span class="booking-subtitle">{{ selectedProfessional?.role === 'PERSONAL_TRAINER' ? 'Personal Trainer' :
          'Nutrizionista' }}</span>
      </div>
      <button class="booking-close" (click)="closeBooking()">‚úï</button>
    </div>

    <div class="booking-loading" *ngIf="isLoading">
      <div class="loading-spinner"></div>
      <div class="loading-text">Caricamento disponibilit√†...</div>
    </div>

    <div class="booking-body" *ngIf="!isLoading">

      <!-- Stato vuoto: il professionista non ha slot -->
      <div class="booking-empty" *ngIf="bookingDays.length === 0">
        <div class="booking-empty-icon">üìÖ</div>
        <p class="booking-empty-title">Nessuna disponibilit√†</p>
        <p class="booking-empty-sub">Questo professionista non ha ancora inserito disponibilit√† per i prossimi giorni.
        </p>
      </div>

      <ng-container *ngIf="bookingDays.length > 0">
        <!-- Day Selector -->
        <div class="booking-section-title">Seleziona una data</div>
        <div class="booking-day-selector">
          <button class="booking-day-card" *ngFor="let day of bookingDays"
            [class.selected]="selectedBookingDay && day.getTime() === selectedBookingDay.getTime()"
            (click)="selectBookingDay(day)">
            <span class="bdc-name">{{ getDayName(day) }}</span>
            <span class="bdc-num">{{ getDayNumber(day) }}</span>
            <span class="bdc-month">{{ day.toLocaleDateString('it-IT', { month: 'short' }) }}</span>
          </button>
        </div>

        <!-- Slot Selector -->
        <div class="booking-section-title" style="margin-top: 1.5rem;">Orari disponibili</div>
        <div class="booking-slot-grid" *ngIf="slotsForSelectedDay.length > 0">
          <button class="booking-time-pill" *ngFor="let slot of slotsForSelectedDay"
            [class.selected]="isBookingSlotSelected(slot)" (click)="toggleBookingSlot(slot)">
            {{ getSlotTimeLabel(slot) }}
          </button>
        </div>
        <div class="booking-empty-slots" *ngIf="selectedBookingDay && slotsForSelectedDay.length === 0">
          Nessun orario disponibile in questa data.
        </div>
      </ng-container>

    </div>

    <!-- Footer -->
    <div class="booking-footer" *ngIf="!isLoading">
      <div class="booking-selection-info" *ngIf="selectedBookingSlot && selectedBookingDay">
        <span class="bsi-label">Data selezionata:</span>
        <span class="bsi-value">{{ selectedBookingDay.toLocaleDateString('it-IT', { weekday: 'long', day: 'numeric',
          month: 'long' }) }} alle {{ getSlotTimeLabel(selectedBookingSlot) }}</span>
      </div>
      <div class="booking-selection-info empty" *ngIf="!selectedBookingSlot">
        Seleziona un orario per continuare
      </div>
      <div class="booking-footer-actions">
        <button class="btn-avail-cancel" (click)="closeBooking()">Annulla</button>
        <button class="btn-book-confirm" (click)="confirmBooking()" [disabled]="!selectedBookingSlot">
          Conferma Prenotazione
        </button>
      </div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ MODALE SUCCESSO GLOBALE ‚îÄ‚îÄ -->
  <div class="global-popup-overlay" *ngIf="isPopupOpen" (click)="closePopup()"></div>
  <div class="global-popup" *ngIf="isPopupOpen">
    <div class="global-popup-icon">‚úì</div>
    <div class="global-popup-title">{{ popupTitle }}</div>
    <div class="global-popup-message">{{ popupMessage }}</div>
    <button class="global-popup-btn" (click)="closePopup()">OK, ho capito</button>
  </div>

</div>