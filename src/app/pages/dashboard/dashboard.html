<div class="flex flex-col h-[100dvh] overflow-hidden bg-[#f2f6fc] font-['DM_Sans'] text-[#1a2744]">

  <!-- ‚îÄ‚îÄ TOPBAR ‚îÄ‚îÄ -->
  <header class="flex-shrink-0 flex items-center justify-between
                 px-4 lg:px-7 h-[calc(3.5rem+env(safe-area-inset-top))] sm:h-[calc(4rem+env(safe-area-inset-top))]
                 pt-[env(safe-area-inset-top)]
                 bg-[#1a3462] border-b border-[#c9a96e]/20
                 shadow-[0_2px_20px_rgba(26,52,98,0.30)] z-50 gap-2 sm:gap-3 lg:gap-4">

    <!-- Brand logo -->
    <div class="flex items-center flex-shrink-0">
      <img src="assets/images/navalgold_logo.png" alt="Naval Gold Logo"
        class="brand-logo-img h-10 sm:h-12 w-auto object-contain">
    </div>

    <!-- Week navigation (centre) -->
    <div class="flex items-center gap-1 sm:gap-2 flex-1 justify-center min-w-0">
      <button class="nav-btn w-8 h-8 flex items-center justify-center
                     bg-white/10 border border-white/20 rounded-lg
                     text-white/65 text-base cursor-pointer transition-all flex-shrink-0"
        (click)="prevWeek()">‚Äπ</button>

      <span class="hidden sm:block text-center text-[0.85rem] font-medium
                   text-white/90 tracking-[0.01em] whitespace-nowrap
                   min-w-[140px] md:min-w-[200px]">
        {{ getWeekLabel() }}
      </span>

      <button class="nav-btn w-8 h-8 flex items-center justify-center
                     bg-white/10 border border-white/20 rounded-lg
                     text-white/65 text-base cursor-pointer transition-all flex-shrink-0"
        (click)="nextWeek()">‚Ä∫</button>

      <button class="today-btn px-2 sm:px-3 py-1 bg-[#c9a96e]/15 border border-[#c9a96e]/45
                     rounded-[6px] text-[#e8c97a] text-[0.75rem] sm:text-[0.78rem] font-semibold
                     uppercase tracking-[0.05em] cursor-pointer transition-all flex-shrink-0"
        [class.hidden]="agendaView" [class.sm:block]="agendaView" (click)="goToToday()">Oggi</button>

      <!-- Vista Agenda ‚Äî solo su mobile -->
      <button class="sm:hidden agenda-toggle-btn flex-shrink-0
                     flex items-center gap-1 px-2 py-1
                     border border-white/20 rounded-[6px]
                     text-[0.7rem] font-semibold tracking-[0.03em]
                     cursor-pointer transition-all" [class.active]="agendaView" (click)="toggleAgendaView()"
        title="Vista agenda">
        <span>‚ò∞</span>
      </button>
    </div>

    <!-- Right section -->
    <div class="flex items-center gap-2 sm:gap-3 lg:gap-4 flex-shrink-0">

      <!-- Week stat (professionals only) ‚Äî desktop only -->
      <div class="hidden md:flex flex-col items-end gap-[1px]" *ngIf="!isLoading && isProfessional()">
        <span class="text-[1.1rem] font-bold text-[#e8c97a] leading-none tabular-nums">{{ countWeekBookings() }}</span>
        <span class="text-[0.6rem] text-white/40 uppercase tracking-[0.10em]">questa settimana</span>
      </div>

      <!-- Credits + Book (clients with active subscription) -->
      <div class="hidden sm:flex items-center gap-2 pr-3 sm:pr-4 border-r border-white/15"
        *ngIf="!isLoading && isClient() && subscription?.active">
        <div class="flex items-center gap-1">
          <div class="topbar-credit-badge flex items-center gap-1 px-2 py-[0.2rem]
                       bg-[#c9a96e]/15 border border-[#c9a96e]/30 rounded-[6px]
                       text-[#e8c97a] text-[0.8rem] font-semibold transition-all">
            <span>üí™</span>
            <span class="tabular-nums">{{ subscription.remainingPtCredits }}</span>
          </div>
          <div class="topbar-credit-badge flex items-center gap-1 px-2 py-[0.2rem]
                       bg-[#c9a96e]/15 border border-[#c9a96e]/30 rounded-[6px]
                       text-[#e8c97a] text-[0.8rem] font-semibold transition-all">
            <span>ü•ó</span>
            <span class="tabular-nums">{{ subscription.remainingNutritionistCredits }}</span>
          </div>
        </div>
        <button class="btn-book-topbar px-3 sm:px-4 py-[0.35rem] rounded-[6px] text-[#1a3462]
                       text-[0.85rem] font-bold cursor-pointer transition-all" (click)="toggleProfile()">
          Prenota
        </button>
      </div>

      <!-- Availability button (professionals only) -->
      <button *ngIf="isProfessional()" class="btn-avail-topbar" (click)="openAvailability()"
        title="Gestisci disponibilit√† settimana prossima">
        <span>üìÖ</span>
        <span class="hidden sm:inline">Disponibilit√†</span>
      </button>

      <!-- Profile button -->
      <button class="profile-btn w-9 h-9 sm:w-[38px] sm:h-[38px] rounded-full border-2 border-[#c9a96e]/50
                     bg-[#c9a96e]/12 cursor-pointer flex items-center justify-center
                     transition-all overflow-hidden p-0 flex-shrink-0" (click)="toggleProfile()"
        [class.active]="isProfileOpen">
        <img *ngIf="currentUser?.profilePicture" [src]="currentUser.profilePicture" alt="Avatar"
          class="w-full h-full object-cover">
        <span *ngIf="!currentUser?.profilePicture" class="text-[0.78rem] font-bold text-[#c9a96e]">{{ getInitials()
          }}</span>
      </button>
    </div>
  </header>

  <!-- ‚îÄ‚îÄ CALENDARIO / AGENDA ‚îÄ‚îÄ -->
  <div class="flex-1 flex flex-col overflow-hidden relative">

    <!-- Loading overlay -->
    <div class="loading-overlay absolute inset-0 bg-[#f2f6fc]/88 z-20
                flex flex-col items-center justify-center gap-4 backdrop-blur-[6px]" *ngIf="isLoading">
      <div class="loading-spinner w-9 h-9 rounded-full border-2 border-[#c9a96e]/20 border-t-[#c9a96e]"></div>
      <span class="text-[0.8rem] text-[#8fa3c8] uppercase tracking-[0.08em]">Caricamento in corso...</span>
    </div>

    <!-- Intestazione giorni (nascosta in agenda view su mobile) -->
    <div
      class="calendar-header flex-shrink-0 bg-[#1a3462]
                border-b border-[#c9a96e]/18
                grid grid-cols-[44px_repeat(3,1fr)] sm:grid-cols-[48px_repeat(3,1fr)] lg:grid-cols-[56px_repeat(7,1fr)]"
      [class.hidden]="agendaView">
      <div class="border-r border-white/10"></div>
      <div class="day-header flex flex-col items-center py-[0.7rem] border-r border-white/8 gap-[0.3rem]"
        *ngFor="let day of weekDays" [class.today]="isToday(day)">
        <span class="day-name text-[0.62rem] font-semibold text-white/42 tracking-[0.14em] uppercase leading-none">
          {{ getDayName(day) }}
        </span>
        <span class="day-number text-base font-medium text-white/82 w-[30px] h-[30px]
                     flex items-center justify-center rounded-full transition-all"
          [class.today-circle]="isToday(day)">{{ getDayNumber(day) }}</span>
      </div>
    </div>

    <!-- Griglia scrollabile (nascosta in agenda view su mobile) -->
    <div class="calendar-grid-scroll flex-1 overflow-y-scroll overflow-x-hidden pb-[env(safe-area-inset-bottom)]"
      [class.hidden]="agendaView">
      <div
        class="calendar-grid min-h-full bg-[#f2f6fc]
                  grid grid-cols-[44px_repeat(3,1fr)] sm:grid-cols-[48px_repeat(3,1fr)] lg:grid-cols-[56px_repeat(7,1fr)]">

        <!-- Colonna ore -->
        <div class="time-col border-r border-[#ccd8ed] sticky left-0 bg-white z-[5]
                    shadow-[2px_0_8px_rgba(26,52,98,0.05)]">
          <div class="time-slot-label" *ngFor="let slot of timeSlots" [class.full-hour]="isFullHour(slot)"
            [class.half-hour]="!isFullHour(slot)">
            {{ slot }}
          </div>
        </div>

        <!-- Colonne giorni -->
        <div class="day-col border-r border-[#ccd8ed]/60" *ngFor="let day of weekDays" [class.today-col]="isToday(day)">
          <div class="hour-cell" *ngFor="let slot of timeSlots" [class.full-hour]="isFullHour(slot)"
            [class.half-hour]="!isFullHour(slot)">
            <div class="booking-card cursor-pointer" *ngFor="let b of getBookingsForSlot(day, slot)"
              [class]="'booking-card ' + getBookingClass(b)" (click)="openCallModal(b)">
              <div class="booking-time">{{ b.startTime }} ‚Äì {{ b.endTime }}</div>
              <div class="booking-name">{{ getBookingLabel(b) }}</div>
              <div class="booking-status" [class]="'status-' + b.status?.toLowerCase()">
                {{ b.status === 'CONFIRMED' ? '‚óè Confermata' : b.status === 'PENDING' ? '‚óã In attesa' : '‚úï Annullata' }}
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- Stato vuoto -->
    <div class="empty-state absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2
                text-center pointer-events-none" *ngIf="!isLoading && bookings.length === 0 && !agendaView">
      <div class="text-[2.5rem] mb-3 opacity-35">üìÖ</div>
      <p class="empty-title font-['Darker_Grotesque'] text-[1.05rem] font-extrabold italic text-[#ccd8ed] mb-1">Nessuna
        prenotazione</p>
      <p class="text-[0.78rem] text-[#e0e8f5]" *ngIf="isClient()">Non hai ancora prenotazioni con i tuoi professionisti.
      </p>
      <p class="text-[0.78rem] text-[#e0e8f5]" *ngIf="isProfessional()">Nessun cliente ha ancora prenotato con te.</p>
    </div>

    <!-- ‚îÄ‚îÄ AGENDA VIEW (solo mobile, attiva quando agendaView=true) ‚îÄ‚îÄ -->
    <div
      class="agenda-view sm:hidden flex-1 overflow-y-auto px-4 pt-4 pb-[calc(1rem+env(safe-area-inset-bottom))] flex flex-col bg-[#f2f6fc]"
      *ngIf="agendaView">
      <!-- Loading -->
      <div class="flex justify-center py-12" *ngIf="isLoading">
        <div class="loading-spinner w-8 h-8 rounded-full border-2 border-[#c9a96e]/20 border-t-[#c9a96e]"></div>
      </div>
      <!-- Lista giorni -->
      <ng-container *ngIf="!isLoading">
        <ng-container *ngFor="let day of getAgendaDays()">
          <div class="agenda-day-block mb-5 last:mb-0">
            <!-- Header giorno -->
            <div class="flex items-center gap-3 mb-2">
              <div class="agenda-date-badge flex-shrink-0 w-11 bg-white border border-[#ccd8ed]
                          rounded-[10px] py-[5px] text-center shadow-sm" [class.today-badge]="isToday(day)">
                <div class="text-[1.1rem] font-black leading-none" [style.color]="isToday(day) ? '#c9a96e' : '#1a2744'">
                  {{ getDayNumber(day) }}</div>
                <div class="text-[0.58rem] font-semibold uppercase tracking-wide text-[#8fa3c8]">{{ getMonthShort(day)
                  }}</div>
              </div>
              <div class="flex-1 h-px bg-[#ccd8ed]/55"></div>
              <span class="text-[0.68rem] font-semibold text-[#c9a96e] uppercase tracking-wide flex-shrink-0"
                *ngIf="isToday(day)">Oggi</span>
            </div>
            <!-- Booking rows -->
            <div class="ml-[52px] flex flex-col gap-[6px]">
              <div class="agenda-booking-row flex items-center gap-3 px-4 py-[10px]
                          bg-white border border-[#ccd8ed] rounded-xl shadow-sm cursor-pointer"
                *ngFor="let b of getBookingsForAgendaDay(day)" [class.opacity-50]="b.status === 'CANCELLED'"
                (click)="openCallModal(b)">
                <div class="w-[7px] h-[7px] rounded-full flex-shrink-0"
                  [style.backgroundColor]="b.status === 'CANCELLED' ? '#8fa3c8' : b.professionalRole === 'NUTRITIONIST' ? '#2d5fa8' : '#1a3462'">
                </div>
                <div class="flex-1 min-w-0">
                  <div class="text-[0.875rem] font-semibold text-[#1a2744] truncate">{{ getBookingLabel(b) }}</div>
                  <div class="text-[0.74rem] text-[#8fa3c8] font-medium">{{ b.startTime }} ‚Äì {{ b.endTime }}</div>
                </div>
                <span class="text-[0.7rem] font-bold flex-shrink-0"
                  [style.color]="b.status === 'CONFIRMED' ? '#10b981' : b.status === 'PENDING' ? '#f59e0b' : '#8fa3c8'">
                  {{ b.status === 'CONFIRMED' ? '‚óè' : b.status === 'PENDING' ? '‚óã' : '‚úï' }}
                </span>
              </div>
              <p class="text-[0.76rem] text-[#ccd8ed] italic py-[2px]"
                *ngIf="getBookingsForAgendaDay(day).length === 0">Nessuna prenotazione</p>
            </div>
          </div>
        </ng-container>
      </ng-container>
    </div>

  </div>

  <!-- ‚îÄ‚îÄ MODALE ACCESSO CALL ‚îÄ‚îÄ -->
  <div class="fixed inset-0 bg-[#1a3462]/30 backdrop-blur-[4px] z-[120] flex items-center justify-center p-4"
    style="animation: fadeIn 0.2s ease" *ngIf="isCallModalOpen">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden flex flex-col"
      style="animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1)">

      <!-- Header modale -->
      <div class="px-6 py-5 bg-[#1a3462] border-b border-[#c9a96e]/20 flex justify-between items-start">
        <h3 class="text-xl font-bold text-white leading-tight">Dettagli Chiamata</h3>
        <button class="text-white/60 hover:text-white transition-colors" (click)="closeCallModal()">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>

      <!-- Corpo modale -->
      <div class="p-6 flex flex-col gap-4" *ngIf="selectedCallBooking">

        <div class="flex items-center gap-3">
          <div
            class="w-10 h-10 rounded-full bg-[#f2f6fc] flex items-center justify-center text-[#1a2744] font-bold text-lg">
            {{ selectedCallBooking.professionalName ? selectedCallBooking.professionalName.charAt(0) :
            selectedCallBooking.clientName?.charAt(0) }}
          </div>
          <div>
            <div class="text-[0.7rem] uppercase tracking-wider text-[#8fa3c8] font-bold mb-[2px]">Con chi</div>
            <div class="text-[1.05rem] font-bold text-[#1a2744]">{{ getBookingLabel(selectedCallBooking) }}</div>
          </div>
        </div>

        <div class="h-px bg-[#ccd8ed]/50 my-1"></div>

        <div class="flex gap-6">
          <div>
            <div class="text-[0.7rem] uppercase tracking-wider text-[#8fa3c8] font-bold mb-[2px]">Data</div>
            <div class="text-[0.95rem] font-semibold text-[#1a2744]">{{ selectedCallBooking.date }}</div>
          </div>
          <div>
            <div class="text-[0.7rem] uppercase tracking-wider text-[#8fa3c8] font-bold mb-[2px]">Orario</div>
            <div class="text-[0.95rem] font-semibold text-[#1a2744]">{{ selectedCallBooking.startTime }} - {{
              selectedCallBooking.endTime }}</div>
          </div>
        </div>

        <div class="h-px bg-[#ccd8ed]/50 my-1"></div>

        <!-- Stato -->
        <div>
          <span
            class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-md text-[0.75rem] font-bold uppercase tracking-wider"
            [class.bg-emerald-50]="selectedCallBooking.status === 'CONFIRMED'"
            [class.text-emerald-600]="selectedCallBooking.status === 'CONFIRMED'"
            [class.bg-amber-50]="selectedCallBooking.status === 'PENDING'"
            [class.text-amber-600]="selectedCallBooking.status === 'PENDING'"
            [class.bg-slate-100]="selectedCallBooking.status === 'CANCELLED'"
            [class.text-slate-500]="selectedCallBooking.status === 'CANCELLED'">
            <span class="w-1.5 h-1.5 rounded-full" [class.bg-emerald-500]="selectedCallBooking.status === 'CONFIRMED'"
              [class.bg-amber-500]="selectedCallBooking.status === 'PENDING'"
              [class.bg-slate-400]="selectedCallBooking.status === 'CANCELLED'"></span>
            {{ selectedCallBooking.status === 'CONFIRMED' ? 'Confermata' : selectedCallBooking.status === 'PENDING' ?
            'In attesa' : 'Annullata' }}
          </span>
        </div>

        <!-- Text accesso -->
        <p class="text-[0.8rem] text-[#8fa3c8] leading-relaxed mt-2"
          *ngIf="selectedCallBooking.status === 'CONFIRMED' && !canJoinCallNow">
          Il link per accedere alla videochiamata sar√† disponibile <strong class="text-[#1a2744]">30 minuti
            prima</strong> dell'inizio dell'appuntamento.
        </p>
        <p class="text-[0.8rem] text-emerald-600 font-medium leading-relaxed mt-2"
          *ngIf="selectedCallBooking.status === 'CONFIRMED' && canJoinCallNow">
          La chiamata √® aperta! Puoi accedere premendo il bottone qui sotto.
        </p>
        <p class="text-[0.8rem] text-amber-600 font-medium leading-relaxed mt-2"
          *ngIf="selectedCallBooking.status === 'PENDING'">
          La chiamata deve ancora essere confermata dal professionista.
        </p>

        <!-- Bottone Accedi -->
        <button
          class="mt-4 w-full py-3.5 rounded-xl text-[0.95rem] font-bold uppercase tracking-wide transition-all flex items-center justify-center gap-2"
          [ngClass]="canJoinCallNow && selectedCallBooking.status === 'CONFIRMED' ? 'bg-[#1a3462] hover:bg-[#112344] text-white shadow-lg shadow-[#1a3462]/20' : 'bg-[#e0e8f5] text-[#8fa3c8] cursor-not-allowed'"
          [disabled]="!canJoinCallNow || selectedCallBooking.status !== 'CONFIRMED'" (click)="joinCall()">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"
            *ngIf="canJoinCallNow && selectedCallBooking.status === 'CONFIRMED'">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z">
            </path>
          </svg>
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"
            *ngIf="!canJoinCallNow || selectedCallBooking.status !== 'CONFIRMED'">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z">
            </path>
          </svg>
          {{ canJoinCallNow && selectedCallBooking.status === 'CONFIRMED' ? 'Accedi alla Call' : 'Link non ancora
          attivo' }}
        </button>

      </div>
    </div>
  </div>


  <!-- ‚îÄ‚îÄ OVERLAY PROFILO ‚îÄ‚îÄ -->
  <div class="fixed inset-0 bg-[#1a3462]/28 z-[100] backdrop-blur-[4px]" style="animation: fadeIn 0.2s ease"
    *ngIf="isProfileOpen" (click)="closeProfile()"></div>

  <!-- ‚îÄ‚îÄ PANNELLO PROFILO ‚îÄ‚îÄ -->
  <aside class="profile-panel fixed top-0 right-0 h-screen
                w-full sm:w-80
                bg-white border-l border-[#ccd8ed] z-[101]
                flex flex-col shadow-[-12px_0_48px_rgba(26,52,98,0.14)]" [class.open]="isProfileOpen">

    <div class="panel-header flex items-center justify-between
                px-6 py-5 border-b border-[#ccd8ed] flex-shrink-0 bg-[#1a3462]">
      <span class="panel-title font-['Darker_Grotesque'] text-[1.15rem] font-extrabold tracking-[0.03em]">Il tuo
        Profilo</span>
      <button class="w-7 h-7 bg-white/12 border border-white/20 rounded-[6px]
                     text-white/60 text-[0.75rem] cursor-pointer flex items-center justify-center transition-all"
        (click)="closeProfile()">‚úï</button>
    </div>

    <div class="panel-body flex-1 overflow-y-auto px-5 py-7
                flex flex-col items-center gap-[0.9rem] bg-[#f2f6fc]">

      <ng-container *ngIf="isLoading">
        <div class="skeleton-avatar w-[82px] h-[82px] rounded-full bg-[#ccd8ed]"></div>
        <div class="skeleton-line wide h-[13px] rounded-md bg-[#ccd8ed] w-4/5"></div>
        <div class="skeleton-line narrow h-[13px] rounded-md bg-[#ccd8ed] w-[48%]"></div>
      </ng-container>

      <ng-container *ngIf="!isLoading && dashboardData">

        <div class="panel-avatar-wrap relative mb-1">
          <img *ngIf="currentUser?.profilePicture" [src]="currentUser.profilePicture" alt="Avatar"
            class="w-[82px] h-[82px] rounded-full object-cover border-2 border-[#c9a96e] relative z-[1]">
          <div *ngIf="!currentUser?.profilePicture" class="panel-avatar-fallback w-[82px] h-[82px] rounded-full
                      bg-gradient-to-br from-[#1a3462] to-[#2d5fa8]
                      border-2 border-[#c9a96e] text-[#e8c97a]
                      flex items-center justify-center text-[1.8rem] font-black
                      relative z-[1] font-['Darker_Grotesque']">{{ getInitials() }}</div>
          <div class="panel-avatar-ring absolute rounded-full border border-[#c9a96e]/28" style="inset: -6px"></div>
        </div>

        <div class="font-['Darker_Grotesque'] text-[1.35rem] font-black text-[#1a2744] text-center tracking-[0.02em]">
          {{ profile?.firstName }} {{ profile?.lastName }}
        </div>
        <div class="bg-[#1a3462]/8 border border-[#1a3462]/20 text-[#1a3462]
                    px-4 py-[0.22rem] rounded-full text-[0.68rem] font-semibold
                    tracking-[0.12em] uppercase">{{ profile?.role }}</div>

        <!-- Availability button (professionals only) -->
        <button *ngIf="isProfessional()" class="btn-availability" (click)="openAvailability()">
          <span class="btn-availability-icon">üìÖ</span>
          Gestisci Disponibilit√†
          <span class="btn-availability-arrow">‚Üí</span>
        </button>

        <!-- Bottone Clienti (professionals only) -->
        <button *ngIf="isProfessional()"
          class="w-full mt-2 bg-[#c9a96e] hover:bg-[#b8922a] text-[#1a2744] font-bold py-3 rounded-lg shadow-md transition-colors flex justify-center items-center gap-2"
          (click)="goToClients()">
          <span>üë•</span> I Miei Clienti
        </button>

        <!-- Aggiunta: Vista Rapida Clienti -->
        <ng-container *ngIf="isProfessional() && myClients && myClients.length > 0">
          <div class="w-full flex items-center justify-between pb-[0.3rem] border-b border-[#ccd8ed] mt-4 mb-1">
            <span class="text-[0.62rem] font-semibold text-[#8fa3c8] uppercase tracking-[0.12em]">Clienti
              Assegnati</span>
            <span class="text-[0.62rem] font-bold text-[#1a3462] bg-[#c9a96e]/20 px-2 py-0.5 rounded-full">{{
              myClients.length }}</span>
          </div>

          <div class="w-full flex flex-col gap-2 max-h-[180px] overflow-y-auto pr-1">
            <div
              class="detail-row flex items-center gap-3 px-3 py-2
                         bg-white border border-[#ccd8ed] rounded-[10px] transition-all hover:border-[#c9a96e]/60 cursor-pointer shadow-sm"
              *ngFor="let client of myClients">
              <!-- Avatar mini -->
              <div
                class="w-9 h-9 rounded-full bg-[#1a3462] flex items-center justify-center overflow-hidden border-[1.5px] border-[#c9a96e]/60 flex-shrink-0 shadow-inner">
                <img *ngIf="client.profilePictureUrl" [src]="client.profilePictureUrl"
                  class="w-full h-full object-cover">
                <span *ngIf="!client.profilePictureUrl" class="text-[#e8c97a] text-[0.6rem] font-bold uppercase">{{
                  client.firstName?.charAt(0) }}{{ client.lastName?.charAt(0) }}</span>
              </div>
              <div class="flex flex-col min-w-0 flex-1">
                <span class="text-[0.80rem] font-bold text-[#1a2744] truncate leading-tight">{{ client.firstName }} {{
                  client.lastName }}</span>
                <span class="text-[0.65rem] text-[#8fa3c8] font-medium truncate mt-[2px]">{{ client.email }}</span>
              </div>
              <div class="w-5 h-5 rounded-full bg-[#f2f6fc] flex items-center justify-center text-[#c9a96e]">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
              </div>
            </div>
          </div>
        </ng-container>

        <div class="w-full text-[0.62rem] font-semibold text-[#8fa3c8] uppercase tracking-[0.12em]
                    pb-[0.3rem] border-b border-[#ccd8ed] mt-2">Dati Personali</div>
        <div class="w-full flex flex-col gap-2">
          <div class="detail-row flex items-center gap-3 px-4 py-[0.65rem]
                       bg-white border border-[#ccd8ed] rounded-[10px] transition-all">
            <span class="text-[0.88rem] text-[#c9a96e] w-[18px] text-center flex-shrink-0">‚úâ</span>
            <div class="flex flex-col gap-[0.08rem] min-w-0">
              <span class="text-[0.60rem] text-[#8fa3c8] uppercase tracking-[0.10em] font-semibold">Email</span>
              <span class="text-[0.84rem] text-[#1a2744] overflow-hidden text-ellipsis whitespace-nowrap">{{
                profile?.email }}</span>
            </div>
          </div>
        </div>

        <ng-container *ngIf="isClient() && subscription">
          <div class="w-full text-[0.62rem] font-semibold text-[#8fa3c8] uppercase tracking-[0.12em]
                      pb-[0.3rem] border-b border-[#ccd8ed] mt-1">Abbonamento</div>
          <div class="subscription-card w-full rounded-xl p-4 flex flex-col gap-2"
            [class.inactive]="!subscription.isActive">
            <div class="text-[0.95rem] font-semibold text-[#1a2744]">{{ subscription.planName }}</div>
            <div class="sub-status flex items-center gap-2 text-[0.78rem] text-[#8fa3c8]">
              <span class="sub-dot w-[7px] h-[7px] rounded-full bg-[#ccd8ed] flex-shrink-0"
                [class.active]="subscription.isActive"></span>
              {{ subscription.isActive ? 'Attivo' : 'Scaduto' }}
            </div>
            <div class="text-[0.77rem] text-[#8fa3c8]">Scade il {{ subscription.endDate | date:'d MMMM yyyy':'':'it' }}
            </div>
            <div class="text-[0.74rem] text-[#b8922a] font-medium" *ngIf="subscription.isActive">
              {{ getSubscriptionDaysLeft() }} giorni rimanenti
            </div>
            <div class="sub-credits flex gap-2 mt-1">
              <div
                class="credit-item flex-1 bg-white border border-[#ccd8ed] rounded-lg p-2 flex flex-col items-center gap-[0.2rem]">
                <span class="text-base">üí™</span>
                <span class="text-[0.58rem] text-[#8fa3c8] uppercase tracking-[0.08em]">PT</span>
                <span class="text-[1.1rem] font-bold text-[#b8922a]">{{ subscription.remainingPtCredits }}</span>
              </div>
              <div
                class="credit-item flex-1 bg-white border border-[#ccd8ed] rounded-lg p-2 flex flex-col items-center gap-[0.2rem]">
                <span class="text-base">ü•ó</span>
                <span class="text-[0.58rem] text-[#8fa3c8] uppercase tracking-[0.08em]">Nutrizione</span>
                <span class="text-[1.1rem] font-bold text-[#b8922a]">{{ subscription.remainingNutritionistCredits
                  }}</span>
              </div>
            </div>
          </div>
        </ng-container>

        <ng-container *ngIf="isClient() && professionals.length > 0">
          <div class="w-full text-[0.62rem] font-semibold text-[#8fa3c8] uppercase tracking-[0.12em]
                      pb-[0.3rem] border-b border-[#ccd8ed] mt-1">I tuoi Professionisti</div>
          <div class="w-full flex flex-col gap-2">
            <div class="detail-row flex items-center gap-3 px-4 py-[0.65rem]
                         bg-white border border-[#ccd8ed] rounded-[10px] transition-all"
              *ngFor="let p of professionals">
              <span class="text-[0.88rem] text-[#c9a96e] w-[18px] text-center flex-shrink-0">
                {{ p.role === 'PERSONAL_TRAINER' ? 'üí™' : 'ü•ó' }}
              </span>
              <div class="flex flex-col gap-[0.08rem] min-w-0 flex-1">
                <span class="text-[0.60rem] text-[#8fa3c8] uppercase tracking-[0.10em] font-semibold">
                  {{ p.role === 'PERSONAL_TRAINER' ? 'Personal Trainer' : 'Nutrizionista' }}
                </span>
                <span class="text-[0.84rem] text-[#1a2744] overflow-hidden text-ellipsis whitespace-nowrap">{{
                  p.fullName }}</span>
              </div>
              <button class="btn-book-sm" (click)="openBooking(p)">Prenota</button>
            </div>
          </div>
        </ng-container>

      </ng-container>

      <button class="btn-logout w-full mt-auto" (click)="logout()">Esci dall'account ‚Üí</button>

    </div>
  </aside>

  <!-- ‚îÄ‚îÄ MODALE DISPONIBILIT√Ä ‚îÄ‚îÄ -->
  <div class="fixed inset-0 bg-[#1a3462]/38 z-[200] backdrop-blur-[5px]" style="animation: fadeIn 0.2s ease"
    *ngIf="isAvailabilityOpen" (click)="closeAvailability()"></div>

  <div class="avail-modal fixed z-[201] bg-white overflow-hidden flex flex-col
              top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2
              w-[min(96vw,920px)] h-[min(92vh,700px)] rounded-2xl
              max-sm:top-0 max-sm:left-0 max-sm:translate-x-0 max-sm:translate-y-0
              max-sm:w-screen max-sm:h-[100dvh] max-sm:rounded-none" *ngIf="isAvailabilityOpen">

    <!-- Header modale -->
    <div class="flex items-center justify-between px-6 py-[1.1rem] bg-[#1a3462] flex-shrink-0">
      <div class="flex flex-col gap-[0.15rem]">
        <span class="avail-title font-['Darker_Grotesque'] text-[1.1rem] font-black tracking-[0.02em]">
          Disponibilit√† Settimana Prossima
        </span>
        <span class="text-[0.72rem] text-white/52 tracking-[0.04em]">{{ getNextWeekLabel() }}</span>
      </div>
      <button class="w-[30px] h-[30px] bg-white/10 border border-white/18 rounded-[7px]
                     text-white/65 text-[0.75rem] cursor-pointer flex items-center justify-center
                     transition-all flex-shrink-0" (click)="closeAvailability()">‚úï</button>
    </div>

    <!-- Intestazione giorni -->
    <div class="avail-days-header grid border-b border-[#ccd8ed] bg-[#f2f6fc] flex-shrink-0
                grid-cols-[36px_repeat(7,1fr)] sm:grid-cols-[44px_repeat(7,1fr)]">
      <div class="avail-time-gutter border-r border-[#ccd8ed] flex items-center justify-center">
        <button *ngIf="isCopyMode" class="btn-cancel-copy" (click)="clearCopy()" title="Annulla copia">‚úï</button>
      </div>
      <div class="avail-day-header flex flex-col items-center py-[0.55rem] border-r border-[#ccd8ed]/60 gap-[0.2rem]"
        *ngFor="let day of nextWeekDays" [class.is-copy-source]="isCopiedDay(day)">
        <span class="avail-day-name text-[0.60rem] max-sm:text-[0.52rem] font-bold text-[#8fa3c8] tracking-[0.12em]">
          {{ getDayName(day) }}
        </span>
        <span class="avail-day-number text-[0.9rem] max-sm:text-[0.78rem] font-semibold text-[#1a2744]">
          {{ getDayNumber(day) }}
        </span>
        <span *ngIf="isCopiedDay(day)" class="badge-copied">‚úì Copiato</span>
        <button *ngIf="isCopyMode && !isCopiedDay(day)" class="btn-paste-day" (click)="pasteDay(day)">‚¨á Incolla</button>
        <button *ngIf="!isCopyMode" class="btn-copy-day" (click)="copyDay(day)" [disabled]="!hasDaySlots(day)"
          title="Copia disponibilit√†">‚ßâ Copia</button>
      </div>
    </div>

    <!-- Griglia slot -->
    <div class="avail-body flex-1 overflow-y-scroll overflow-x-hidden">
      <div class="avail-grid min-h-full grid grid-cols-[36px_repeat(7,1fr)] sm:grid-cols-[44px_repeat(7,1fr)]">

        <!-- Colonna ore -->
        <div class="avail-time-col border-r border-[#ccd8ed] bg-[#f2f6fc] sticky left-0 z-[2]">
          <div class="avail-time-label" *ngFor="let slot of timeSlots" [class.full-hour]="isFullHour(slot)"
            [class.half-hour]="!isFullHour(slot)">
            {{ isFullHour(slot) ? slot : '' }}
          </div>
        </div>

        <!-- Colonne giorni -->
        <div class="avail-day-col border-r border-[#ccd8ed]/50" *ngFor="let day of nextWeekDays"
          [class.is-paste-target]="isCopyMode && !isCopiedDay(day)" [class.is-copy-source]="isCopiedDay(day)">
          <div class="avail-slot" *ngFor="let slot of timeSlots" [class.full-hour]="isFullHour(slot)"
            [class.half-hour]="!isFullHour(slot)" [class.selected]="isSlotSelected(day, slot)"
            [class.existing]="isSlotExisting(day, slot)" [class.locked]="isSlotLocked(day, slot)"
            (click)="toggleSlot(day, slot)"
            [title]="getDayName(day) + ' ' + getDayNumber(day) + ' ‚Äî ' + slot + (isSlotLocked(day, slot) ? ' (Prenotato)' : '')">
            <span *ngIf="isSlotLocked(day, slot)" class="slot-lock-icon">üîí</span>
          </div>
        </div>

      </div>
    </div>

    <!-- Footer -->
    <div class="avail-footer flex items-center justify-between flex-wrap gap-4 px-6 py-[0.9rem]
                border-t border-[#ccd8ed] bg-white flex-shrink-0
                max-sm:flex-col max-sm:items-stretch">
      <span class="flex items-center gap-2 text-[0.82rem] text-[#8fa3c8]">
        <span class="text-[1.1rem] font-bold text-[#1a3462]">{{ getSelectedCount() }}</span>
        slot selezionati
        <span class="text-[0.75rem] text-[#c9a96e] font-medium">
          ({{ (getSelectedCount() * 0.5).toFixed(1) }}h totali)
        </span>
      </span>
      <div class="flex gap-2 max-sm:justify-end">
        <button class="btn-avail-cancel" (click)="closeAvailability()">Annulla</button>
        <button class="btn-avail-confirm" (click)="confirmAvailability()" [disabled]="getSelectedCount() === 0">
          Conferma Disponibilit√†
        </button>
      </div>
    </div>

  </div>

  <!-- ‚îÄ‚îÄ MODALE PRENOTAZIONE CLIENTE ‚îÄ‚îÄ -->
  <div class="fixed inset-0 bg-[#1a2744]/40 backdrop-blur-[4px] z-[2000]" style="animation: fadeIn 0.3s ease"
    *ngIf="isBookingOpen" (click)="closeBooking()"></div>

  <div class="booking-modal fixed z-[2001] bg-white rounded-xl overflow-hidden flex flex-col
              top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2
              w-[90%] max-w-[540px] max-h-[90vh]" *ngIf="isBookingOpen">

    <!-- Header modale -->
    <div class="flex justify-between items-start px-6 py-5 bg-[#1a2744] border-b-2 border-[#c9a96e]">
      <div class="flex flex-col gap-[0.3rem]">
        <span class="font-['Darker_Grotesque'] text-[1.6rem] font-extrabold leading-tight text-white">
          Prenota con {{ selectedProfessional?.fullName }}
        </span>
        <span class="text-[0.85rem] text-[#c9a96e] font-medium tracking-[0.03em] uppercase">
          {{ selectedProfessional?.role === 'PERSONAL_TRAINER' ? 'Personal Trainer' : 'Nutrizionista' }}
        </span>
      </div>
      <button class="booking-close w-7 h-7 bg-white/10 border-none rounded-full
                     text-white text-[0.9rem] cursor-pointer flex items-center justify-center transition-all"
        (click)="closeBooking()">‚úï</button>
    </div>

    <div class="flex flex-col items-center justify-center gap-4 p-12" *ngIf="isLoading">
      <div class="loading-spinner"></div>
      <div class="text-[#64748b] text-[0.9rem]">Caricamento disponibilit√†...</div>
    </div>

    <div class="booking-body flex-1 overflow-y-auto px-6 py-6 flex flex-col bg-[#f8f9fc]" *ngIf="!isLoading">

      <!-- Stato vuoto -->
      <div class="text-center py-8 px-4" *ngIf="bookingDays.length === 0">
        <div class="text-[2.5rem] mb-4 opacity-80">üìÖ</div>
        <p class="text-[1.1rem] font-semibold text-[#1a2744] mb-2">Nessuna disponibilit√†</p>
        <p class="text-[0.9rem] text-[#64748b] leading-[1.5]">
          Questo professionista non ha ancora inserito disponibilit√† per i prossimi giorni.
        </p>
      </div>

      <ng-container *ngIf="bookingDays.length > 0">
        <div class="text-[0.9rem] font-bold text-[#1a2744] mb-3 uppercase tracking-[0.03em]">Seleziona una data</div>
        <div class="booking-day-selector flex gap-3 overflow-x-auto pb-2">
          <button class="booking-day-card flex-[0_0_auto] w-[72px] py-3 flex flex-col items-center justify-center
                         bg-white border border-[#e2e8f0] rounded-[10px] cursor-pointer transition-all"
            *ngFor="let day of bookingDays"
            [class.selected]="selectedBookingDay && day.getTime() === selectedBookingDay.getTime()"
            (click)="selectBookingDay(day)">
            <span class="bdc-name text-[0.75rem] text-[#64748b] uppercase font-semibold mb-[0.2rem]">{{ getDayName(day)
              }}</span>
            <span
              class="bdc-num font-['Darker_Grotesque'] text-[1.8rem] font-extrabold leading-none text-[#1a2744] mb-[0.1rem]">{{
              getDayNumber(day) }}</span>
            <span class="bdc-month text-[0.75rem] text-[#8fa3c8] font-medium capitalize">{{
              day.toLocaleDateString('it-IT', { month: 'short' }) }}</span>
          </button>
        </div>

        <div class="text-[0.9rem] font-bold text-[#1a2744] uppercase tracking-[0.03em] mt-6 mb-3">Orari disponibili
        </div>
        <div class="flex flex-wrap gap-[0.6rem]" *ngIf="slotsForSelectedDay.length > 0">
          <button class="booking-time-pill px-5 py-[0.6rem] bg-white border border-[#e2e8f0] rounded-full
                         text-[#1a2744] font-semibold text-[0.9rem] cursor-pointer transition-all"
            *ngFor="let slot of slotsForSelectedDay" [class.selected]="isBookingSlotSelected(slot)"
            (click)="toggleBookingSlot(slot)">
            {{ getSlotTimeLabel(slot) }}
          </button>
        </div>
        <div class="p-4 bg-[#1a2744]/3 rounded-lg text-[#64748b] text-[0.9rem] text-center italic"
          *ngIf="selectedBookingDay && slotsForSelectedDay.length === 0">
          Nessun orario disponibile in questa data.
        </div>
      </ng-container>

    </div>

    <!-- Footer -->
    <div class="flex flex-col gap-4 px-6 py-5 bg-white border-t border-[#e2e8f0]" *ngIf="!isLoading">
      <div class="booking-selection-info flex items-center gap-2 text-[0.95rem] px-[0.6rem] py-[0.6rem]
                  bg-[#c9a96e]/10 rounded-md text-[#1a2744]" style="animation: fadeIn 0.3s"
        *ngIf="selectedBookingSlot && selectedBookingDay">
        <span class="font-medium text-[#64748b]">Data selezionata:</span>
        <span class="font-bold text-[#1a2744]">
          {{ selectedBookingDay.toLocaleDateString('it-IT', { weekday: 'long', day: 'numeric', month: 'long' }) }}
          alle {{ getSlotTimeLabel(selectedBookingSlot) }}
        </span>
      </div>
      <div class="text-[#8fa3c8] italic text-[0.95rem]" *ngIf="!selectedBookingSlot">
        Seleziona un orario per continuare
      </div>
      <div class="flex gap-2 justify-end">
        <button class="btn-avail-cancel" (click)="closeBooking()">Annulla</button>
        <button class="btn-book-confirm" (click)="confirmBooking()" [disabled]="!selectedBookingSlot">
          Conferma Prenotazione
        </button>
      </div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ MODALE SUCCESSO GLOBALE ‚îÄ‚îÄ -->
  <div class="fixed inset-0 bg-[#1a2744]/50 z-[3000]" *ngIf="isPopupOpen" (click)="closePopup()"></div>
  <div class="global-popup fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2
              bg-white rounded-2xl p-8 z-[3001] text-center max-w-sm w-[90%]
              shadow-[0_24px_80px_rgba(26,52,98,0.25)]" *ngIf="isPopupOpen">
    <div class="text-[2.5rem] mb-4">‚úì</div>
    <div class="font-['Darker_Grotesque'] text-[1.35rem] font-extrabold text-[#1a2744] mb-2">{{ popupTitle }}</div>
    <div class="text-[0.9rem] text-[#8fa3c8] mb-6">{{ popupMessage }}</div>
    <button class="btn-avail-confirm w-full" (click)="closePopup()">OK, ho capito</button>
  </div>

</div>